// This is the pre-installed code, and is too big to be uploaded via the Web IDE
const initialUrl = "CUSTOM_BADGE_URL"
Badge.URL = initialUrl;

Badge.badgeImages = [{
    // your name image goes here! create with the name-generator in repo
    width: 128, height: 64, bpp: 1,
    buffer: E.toArrayBuffer(atob("CUSTOM_BADGE_IMAGE"))
},
{
    width: 128, height: 64, bpp: 1,
    buffer: E.toArrayBuffer(atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwHAPwD+AH/wH4AAfAcP/B+B4P/g/+B/8H/gAH4PH/wfweH/8P/wf/D/4AB+Dx/8H8Hj//j/+H/x/8Dgfw8f/B/h5//4//x4A+CD+H+PHgAf8ef//P/8eAPAB/x/jx4AHvHn//z//ngHwAf8f88eAB755//8//5/94AH/nvPH/weee///P/+f/eAD/557x/8Hn3n//z//n/3wAf+ef8f/B4/5//8//54A8AH/Hj/H/geH+f//P/8eAPAB/x4/x4AHh/n//j//HgD4MP4eH8eAB4P4//4//h/8f/w4Hg/HgAeB+H/8P/wf/D/8AB4Px4AHgfg/+D/4H/wf+AAeB8eAA4DwD8A/wB/8B+AAHAPDgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf//4PwAfgAAAAAAAAAAAAP//+D8AH4AAAAAAAAAAAAD///g/AB+AAAAAAAAAAAAA///4PwAfgAAAAAAAAAAAAP//+D8AH4AAAAAAAAAAAAD///g/AB+AAAAAAAAAAAAA/gAAPwAfgAAAAAAAAAAAAP4AAD8AH4AAAAAAAAAAAAD+AAA/AB+AAAAAAAAAAAAA/gAAPwAfgAAAAAAAAAAAAP4AAD8AH4AAAAAAAAAAAAD//+A/AB+AAAAAAAAAAAAA///gPwAfgAAAAAAAAAAAAP//4D8AH4AAAAAAAAAAAAD//+A/AB+AAAAAAAAAAAAA///gPwAfgAAAAAAAAAAAAP//4D8AH4AAAAAAAAAAAAD+AAA/AB+AAAAAAAAAAAAA/gAAPwA/gAAAAAAAAAAAAP4AAD+AP4AAAAAAAAAAAAD+AAA/gH8AAAAAAAAAAAAA/gAAH+D/AAAAAAAAAAAAAP//+B///wAAAAAAAAAAAAD///gP//4AAAAAAAAAAAAA///4B//8AAAAAAAAAAAAAP//+AP/+AAAAAAAAAAAAAD///gB/+AAAAAAAAAAAAAAAAAAAB8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="))
},
{
    width: 128, height: 64, bpp: 1,
    buffer: E.toArrayBuffer(atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4AAAAAAAAAAAAAAAAAAH/+AAAAAAAAAAAAAAAAAAH//AAAAAAAAAAAAAAAAAAD//zwAAAAAAAAAAAAAAAAD//5+AAAAAAAAAAAAAAAAB//+fgAAAAAAAAAAAAAAAA///j5AAAAAAAAAAAAAAAAP//88YAAAAAAAAAAAAAAAHx//AOAAAAAAAAAAAAAAAD4H/4HwAAAAAAB/gAAAAAA8Q//j+AAAAAAAf4AAAAAAePH/5/gAAAAAAGAAAAAAAHn5/+f4AAAAAABgAAAAAAB5+f/n/AcAwDgCYAOAMGHA+fH/5/w/g/D+L2AP4XP74Pzz/+f8MMYYhjhgGDHDDjD8Af/n/DBECAIwfxARggwQ/gH/5/4gTAgCMH8wGQIMEP+Y/+f+IE/8PjBgMBkCDBD/nH/n/iBMAOIgYDAZAgwQ/54/5/4gTAGCIGAwGQIMEP+fH+f8IEwBgiBgMBECDBD/n4/n/CBGAYYgYBgxAgwQ/5/H5/wgRznOIGAO4QIMEH+f4+f8IEHw+iBgB8ECDBB/n/Hn/AAAAAAAAAAAAAAAf5/45/gAAAAAAAAAAAAAAD8f/AP4AAAAAAAAAAAAAAA+B/4B8AAAAAAAAAAAAAAAHAP/APAAAAAAAAAAAAAAABjz/zxgAAAAAAAAAAAAAAAJ8f4+QAAAAAAAAAAAAAAAAfn+fgAAAAAAAAAAAAAAAAH5/n4AAAAAAAAAAAAAAAAA8f88AAAAAAAAAAAAAAAAAAP/AAAAAAAAAAAAAAAAAAAH/4AAAAAAAAAAAAAAAAAAD//AAAAAAAAAAAAAAAAAAAH+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="))
}];
const prefix = '////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////'
Badge.partyParrot = [
    "//////////////////////////7///////////////////39/////////////////8UAAD////////////////gqvkD//////////////9wHjOcA//////////////4CPpfph//////////////BFDO/+B/////////////warHoFmB////////////8N3zAADOD////////////hVAKRGBAP///////////4d4LwO8AAP///////////DvgcCNQYC///////////4JkJkJMgBj//////////+H/4ux/5HGH//////////wPUj9Bp0Zgf/////////8F73+WBSh+x//////////gsr+743AGmh/////////8Pp9f/hwY/GD////////vh3tVo2KpgH8f////////+H93994PYLHi/////////w/e/9+Afw+hB/////////Fy+7puCmHTSP////////4enFt9gOgMR4/////////AP/j2scCC+/j////////4Hf+867kA/esf////////gO3P/d7gCOrh////////4sCvl/56gvNdH////////hgfoc/6GGZCIf///////4GV+734Nof1dH////////D+MuOd/9/jhgf///////gK3BPvHJ7/iXx///////8B/6A+/8p+Z+eH//////8A/16B2dd896P4f/////+gXeLqAW1f7c0Uj/////9gvyf3LBAfdr8M+H/////gH7Y/y+6aO3Wuu4v////4JgBPtb4O+/vte5g////+Bq/M3q/xRn/if35j////4Pt04fH34P/U987eH////Fh2ztq3vGz8PlnvQP///03PuR1+vf/2sdZ364f///ifNe/fHi/viehP7/g///8AIMJEEQAIAACAA8AD///gAAAAAAAAAAAAAAAAH/8=",
    "OP/////////////////+AAA/////////////////ADsgP///////////////g1/54D//////////////4Pf/f3D/////////////9Hfu7usD/////////////g0fnCDWH////////////8O6uIADUH////////////B1L0FADgf///////////4uwGgfsAA////////////CaAUGiggB///////////4OMCYw8SCHf//////////HYafAhsMIH//////////wX+G8NaYe4f//////////jltPoKjBWwf/////////4Hvv5hnKO/g//////////Bb1N6B6c98o/////////+MvJl8ZYBe6D/////////xfzsx5ygbzuH////////+G2/j2B1A9f0X////////4NrFf7HwBvfof////////wr1x+4Twv/2h/////////NaP/64EHL33H////////8a+1/YAkfscsf////////xf3+i/wNdbvQ/////////B+1u9uge7zeH////////+cz7XfcDFNH4f////////4Yr92t6P3xth/////////ge/ff9f/g+qP/////////gc21aqe6vzc/////////+AT3+d56mbpgf////////wQdm1+U/v/ugP////////mAGv/d8/qNokB///////4doBW43ReRxQ2Af//////B5yAVb//37vNqAf/////4f/WAD3olH/OVvwH/////Dm2sAzXy6zPfP+4H////w73b2Ovd/W9vqT/IH////H/qkUU+Zs+P39y/cH///4aW9Xf/XffeKdB++mH///g1d5a1ftvmS2s+/W9P//+K3d/Vnb/j586/NWfwP//wXP+Bt/ftre2Y///dAP//EARAAAAAwAQBAAAAEAf/4AAAAAAAAAAAAAAAAAAc=",
    "///////////////////////////////////////////////////////////////////////////////9gAB///+////////////8AAIAH//////////////+AL6bwP//////////////wc+yf4P/////////////8FeHz7QH/////////////A6ff3/8f////////////4SO7/hz4////////////+HXrzAAfw////////////wdp7wAAMD///////////+PeD+A3CAH///////////w+4EYJKAAP//////////+DcQKgFaCA///////////xf+B8ARQAh//////////+L/994Vwi/h//////////4f9fWDTEHsD//////////Erv7uELA72H/////////4b55/wBFHy+H/////////jte+YgmI3OoP////////8PB/24H8D770f////////yVf9n4Y0P/fR////////+Gv///4IAnA+D////////8O/3/dRqCCf4H////////wv/3z9Awc/uwf////////Dn/ov+ADR3Xj////////8Oufn3IIb1fyO////////4F7r8bsD/bbw/////////w8/tv+cLP/9G/////////SLv//S3zev8H////////8B+/rv//+69sC////////4A+/Svu3iOM8I////////AH97+Ti+f7/+QD//////4aL9Hp6/9+vydQC//////w0H7773erP0T+7B//////BQEe//6zx0n8HrAv////8DyAXX3vfv/+99Nwf////xmtAAP//r10L/3T0P////Dv70AL9Z2vX2s/PwH///+H/+vILE+e9XjfbzYH///4d/6fS/N5v+e+w/9wD///hZAiEBAAAgAAAgCIgP///CAAAAAAAAAAAAAAAAH/8=",
    "////////////////////////////////////////f///////////////////////////////////////////f////////////////////////////////////////////////////////////9////////////////////4cj/////////////////+ABAf//////////////+8A6tAD///////////////AuFtwB//////////////gbf5++D/////////////gX9/3/9D////////////8DP3939/X////////////w//9eE/MP///////////8b776AAD4P///////////B7hPwDAEgf//////////4Fsg+LB4YB/////////3/B/8BuC2gAHv/////////8X/wOwA2IAf//////////hu73/lsUEwf/////////8H6//4NIA/g//////////Df/+/xhQH7h/////////8Pf//2EAwT+b/////////x/18/8ORA/6H////////+D///foBiL38P////////wTf///glQn75/////////Dva///FEDXfh///////+8ef87f8AI/7+H////////x/s//90LD2XY/////////H7////hwvv+D////////g//3P/9Aj934P////////n1Xvu3/AO+vx////////8D//6/fsEd+/P////////wP7/f+z8X//w////////wAOP/99/87v/H3/7/////Dwv//+uHv7/8f///////x8gO2967s/v/j///////8f9kB/z7////mH///////BX5cABr/9/+/4f//////8f//vAA/e//97h///////h//9r9S7fqu9kH//////8EBBgAAAAAKbQoP//////wAAAAAAAAAAAAAf////8=",
    "/////////////////////////v///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9gAO////////////////4AhBAv//////////////8APndAH//////////////A+Yz9wH/////////////w6du+7OH////////////8Fc7vr/uH///////////+B637AI/sP///////////w9fGaAA2Qf//////////8B8lCg1V0w///////////A1cBsCpCAH//////////4J+wIAlYICH/////////+C+9AsAQIBVf/////////gV7eXoIyhGR/////////+H6v+/ilUB7D/////////gpe/p9Bnob8P////////4A7vniQaYx/Kf////////i+j9PVgBgLsg////////8Bn2/O+DrAdfD///////+gHg5f3cHsB/4P///////8A9/611cKUNn8f///////iFL/ltmgDD+8R///////+Ab9/muFgwSe9H///////gwJFm5O+Az83sf//////wDD32mVz4AL7dD//////4B/D/1r/X4A7zsf/////8BfoC7W7f+sHmfg//////jCT+B/mXq+ZUmqP/////gK//wD95X5Zm79w/////4C2+ZeB/33+6sd8H////+HP/5f4Ad9nnQn+Y////vh/qu4+2wJx71vtrj////wT5P+39N0AAp/+68P///4Tnv5T+qpthR795Xw////wrB+279v9v8b378fB///4N71Xlfdz3dv9+LrcP///ghRCAZQAgBQYkAAhAf//+AAAAAAAAAAAAAAAAA//8=",
].map(function (buff) {
      return {width: 124, height: 64, bpp: 1, transparent: 0, buffer: E.toArrayBuffer(atob(prefix + buff))};
});
// Get it all back to normal-ish
Badge.reset = () => {
 clearInterval();
 clearWatch();
 Badge.URL = initialUrl;
 NRF.nfcURL(Badge.URL);
 Bluetooth.removeAllListeners();
 LoopbackB.removeAllListeners();
 g.setRotation(0, 1);
 g.clear();
 g.flip();
};
Badge.drawCenter = s => {
  g.clear();
  s.split("\n").forEach((s, i) => g.drawString(s, (128-g.stringWidth(s))/2, i*6));
  g.flip();
};
// User-defined apps
Badge.apps = {};
// Main menu
Badge.menu = () => {
 function wait(cb) { m = { move: cb, select: cb }; }
 var mainmenu = {
  "": { "title": "-- Choose your Adventure --" },
  "About": function () {
   Badge.drawCenter(`-- NodeConf EU 2017 Badge --
Sponsored by NearForm
Battery: ${Badge.getBatteryPercentage()}
Gordon Williams
@Espruino
www.espruino.com
www.nearform.com`);
   wait(e => Badge.menu());
  },
  "Make Connectable": () => {
   Badge.drawCenter(`-- Now Connectable --

You can connect to this badge
with a BLE capable device. Go to
espruino.com/ide on a Web BLE
capable browser to start coding!`);
   g.drawString("Name: Badge " + NRF.getAddress().substr(-5).replace(":", ""), 0, 44);
   g.drawString("MAC: " + NRF.getAddress(), 0, 50);
   g.flip();
   wait(() => { NRF.sleep(); Badge.menu(); });
   NRF.wake();
  },
  "T-Rex": Badge.trex,
  "Join The Party": Badge.proximityParrot,
  "Flappy Bird": Badge.flappy,
  "Sketch": Badge.sketch,
  "Delete Sketch": () => {
   delete Badge.sketchedImage;
   for (var i = 0; i < Badge.badgeImages.length; i++)
    if (Badge.badgeImages[i].sketched)
     Badge.badgeImages.splice(i--, 1);
  },
  "Back to Badge": Badge.badge
 };
 for (var i in Badge.apps) mainmenu[i]=Badge.apps[i];
 Badge.reset();
 var menu = require("graphical_menu");
 var m = menu.list(g, mainmenu);
 setWatch(e => m.move(-1), BTNU, { repeat: 1, debounce: 50, edge: "rising" });
 setWatch(e => m.move(1), BTND, { repeat: 1, debounce: 50, edge: "rising" });
 setWatch(e => m.select(), BTNA, { repeat: 1, debounce: 50, edge: "rising" });
}
Badge.badge = () => {
 Badge.reset();
 var counter = 0;
 var timeout;
 function draw(n) {
  counter += n ? n : 0;
  if (counter < 0) counter = Badge.badgeImages.length - 1;
  if (counter >= Badge.badgeImages.length) counter = 0;
  g.clear();
  g.drawImage(Badge.badgeImages[counter]);
  g.flip();
  var delay = (counter==0) ? 20000 : 2500;
  if (timeout) clearTimeout(timeout);  
  timeout = setTimeout(e => { timeout = undefined; draw(1) }, delay);
 }
 var code = "";
 function k(ch) {
  code = (code + ch).substr(-10);
  if (code == "UUDDLRLRBA") Badge.menu();
 }
 draw(0);
 setWatch(e => k("A"), BTNA, { repeat: 1, debounce: 50, edge: "rising" });
 setWatch(e => k("B"), BTNB, { repeat: 1, debounce: 50, edge: "rising" });
 setWatch(e => k("L"), BTNL, { repeat: 1, debounce: 50, edge: "rising" });
 setWatch(e => k("R"), BTNR, { repeat: 1, debounce: 50, edge: "rising" });
 setWatch(e => { draw(-1); k("U") }, BTNU, { repeat: 1, debounce: 50, edge: "rising" });
 setWatch(e => { draw(1); k("D") }, BTND, { repeat: 1, debounce: 50, edge: "rising" });
}
Badge.trex = () => {
 Badge.reset();
 var IMG = {
  rex: [
   { width: 20, height: 22, bpp: 1, transparent: 0, buffer: E.toArrayBuffer(atob("AB/gA/8AN/AD/wA/8AP/AD4AA/yAfAgfwMP/Dn/Q//wP/8B/+AP/gB/wAP4AB2AAYgAAIAADAP//")) },
   { width: 20, height: 22, bpp: 1, transparent: 0, buffer: E.toArrayBuffer(atob("AB/gA/8AN/AD/wA/8AP/AD4AA/yAfAgfwMP/Dn/Q//wP/8B/+AP/gB/wAP4AB2AAYwAEAABgAP//")) },
   { width: 20, height: 22, bpp: 1, transparent: 0, buffer: E.toArrayBuffer(atob("AB/gAj8AK/ACPwA/8AP/AD4AA/yAfAgfwMP/Dn/Q//wP/8B/+AP/gB/wAP4AB2AAYgAEIABjAP//")) }
  ],
  cacti: [
   { width: 12, height: 24, bpp: 1, transparent: 0, buffer: E.toArrayBuffer(atob("BgDwDwDwDwDyT373737373737373/+f8DwDwDwDwDwDwDwDw")) },
   { width: 8, height: 18, bpp: 1, transparent: 0, buffer: E.toArrayBuffer(atob("GBhY2dnZ2fl5Hx4YGBgYGBgY")) }
  ],
 };
 var cacti, rex, frame;

 function gameStart() {
  rex = {
   alive: true,
   img: 0,
   x: 10, y: 0,
   vy: 0,
   score: 0
  };
  cacti = [{ x: 128, img: 1 }];
  var random = new Uint8Array(128 * 3 / 8);
  for (var i = 0; i < 50; i++) {
   var a = 0 | (Math.random() * random.length);
   var b = 0 | (Math.random() * 8);
   random[a] |= 1 << b;
  }
  IMG.ground = { width: 128, height: 3, bpp: 1, buffer: random.buffer };
  frame = 0;
  setInterval(onFrame, 50);
 }
 function gameStop() {
  rex.alive = false;
  rex.img = 2; // dead
  clearInterval();
  setTimeout(() => setWatch(gameStart, BTNA, { repeat: 0, debounce: 50, edge: "rising" }), 1000);
  setTimeout(onFrame, 10);
 }

 function onFrame() {
  g.clear();
  if (rex.alive) {
   frame++;
   rex.score++;
   if (!(frame & 3)) rex.img = rex.img ? 0 : 1;
   // move rex
   if (BTNL.read() && rex.x > 0) rex.x--;
   if (BTNR.read() && rex.x < 20) rex.x++;
   if ((BTNU.read() || BTNA.read()) && rex.y == 0) rex.vy = 4;
   rex.y += rex.vy;
   rex.vy -= 0.2;
   if (rex.y <= 0) { rex.y = 0; rex.vy = 0; }
   // move cacti
   var lastCactix = cacti.length ? cacti[cacti.length - 1].x : 127;
   if (lastCactix < 128) {
    cacti.push({
     x: lastCactix + 24 + Math.random() * 128,
     img: (Math.random() > 0.5) ? 1 : 0
    });
   }
   cacti.forEach(c => c.x--);
   while (cacti.length && cacti[0].x < 0) cacti.shift();
  } else {
   g.drawString("Game Over!", (128 - g.stringWidth("Game Over!")) / 2, 20);
  }
  g.drawLine(0, 60, 127, 60);
  cacti.forEach(c => g.drawImage(IMG.cacti[c.img], c.x, 60 - IMG.cacti[c.img].height));
  // check against actual pixels
  var rexx = rex.x;
  var rexy = 38 - rex.y;
  if (rex.alive &&
   (g.getPixel(rexx + 0, rexy + 13) ||
   g.getPixel(rexx + 2, rexy + 15) ||
   g.getPixel(rexx + 5, rexy + 19) ||
   g.getPixel(rexx + 10, rexy + 19) ||
   g.getPixel(rexx + 12, rexy + 15) ||
   g.getPixel(rexx + 13, rexy + 13) ||
   g.getPixel(rexx + 15, rexy + 11) ||
   g.getPixel(rexx + 17, rexy + 7) ||
   g.getPixel(rexx + 19, rexy + 5) ||
   g.getPixel(rexx + 19, rexy + 1))) {
   return gameStop();
  }
  g.drawImage(IMG.rex[rex.img], rexx, rexy);
  var groundOffset = frame & 127;
  g.drawImage(IMG.ground, -groundOffset, 61);
  g.drawImage(IMG.ground, 128 - groundOffset, 61);
  g.drawString(rex.score, 127 - g.stringWidth(rex.score));
  g.flip();
 }
 gameStart();
 setWatch(x => Badge.menu(), BTNB, { repeat: 0, debounce: 50, edge: "rising" });
};
Badge.proximityParrot = () => {
  Badge.reset();

  Badge.URL = "http://cultofthepartyparrot.com/";
  NRF.nfcURL(Badge.URL);

  var maxFrameTime = 2500;
  var minFrameTime = 50;
  var neighbourTimeReduction = 400;
  var neighboursWanted = 5
  var neighboursNearby = 0;
  var searchTime = 10000;
  
  // you can customise how many people need to be around to make the parrot party hard!
  setWatch(x => { neighboursWanted = Math.max(neighboursWanted - 1, 0); }, BTNU, { repeat: 1, debounce: 50, edge: "rising" });
  setWatch(x => { neighboursWanted++; }, BTND, { repeat: 1, debounce: 50, edge: "rising" });

  // you can also customise how much faster (or slower) it gets with more people around!
  setWatch(x => { neighbourTimeReduction += 100; }, BTNL, { repeat: 1, debounce: 50, edge: "rising" });
  setWatch(x => { neighbourTimeReduction -= 100; }, BTNR, { repeat: 1, debounce: 50, edge: "rising" });

  function displayGif (gifArray) {
      var currentIndex = -1;
      function drawImage () {
          var currentMax = Math.min((neighboursWanted * neighbourTimeReduction) + neighboursWanted, maxFrameTime)
          currentIndex = ++currentIndex % gifArray.length;
          g.clear();
          g.drawImage(gifArray[currentIndex], 0, 0);
          g.flip();
          setTimeout(() => drawImage(), Math.min(Math.max(minFrameTime, currentMax - (neighbourTimeReduction * neighboursNearby))), currentMax);
      }
      drawImage();
  }
 
  function setupFindNeighboursOnService () {
    setInterval(function () {
        const foundDevices = {}
        neighboursNearby = 0;
        setTimeout(function () { NRF.setScan(); }, 300);
        
        NRF.setScan(function (device) {
            if (device.servicedata && device.servicedata["baaf"] && !foundDevices[device.id]) {
                neighboursNearby++;
                foundDevices[device.id] = true;
            }
            NRF.setScan();
        })
    }, searchTime);
  };
  
  // setup broadcast.
  NRF.setAdvertising({ "0xBAAF": [42] }, { interval: 100 });
  setupFindNeighboursOnService();
  displayGif(Badge.partyParrot);

  // exit with "B"
  setWatch(x => Badge.menu(), BTNB, { repeat: 0, debounce: 50, edge: "rising" });
};
Badge.flappy = () => {
 Badge.reset();
 var SPEED = 0.5;
 var BIRDIMG = {
  width: 8, height: 8, bpp: 1,
  transparent: 0,
  buffer: new Uint8Array([
            0b00000000,
            0b01111000,
            0b10000100,
            0b10111010,
            0b10100100,
            0b10000100,
            0b01111000,
            0b00000000]).buffer
 };

 var birdy, birdvy;
 var wasPressed = false;
 var running = false;
 var barriers;
 var score;

 function newBarrier(x) {
  barriers.push({
   x1: x - 5,
   x2: x + 5,
   y: 10 + Math.random() * (g.getHeight() - 20),
   gap: 8
  });
 }

 function gameStart() {
  running = true;
  birdy = g.getHeight() / 2;
  birdvy = 0;
  barriers = [];
  newBarrier(g.getWidth() / 2);
  newBarrier(g.getWidth());
  score = 0;
  wasPressed = false;
  setInterval(onFrame, 50);
 }

 function gameStop() {
  running = false;
  clearInterval();
  setTimeout(() => setWatch(gameStart, BTNA, { repeat: 0, debounce: 50, edge: "rising" }), 1000);
  setTimeout(onFrame, 10);
 }

 function onFrame() {
  var buttonState = BTN.read();

  g.clear();
  if (!running) {
   g.drawString("Game Over!", 25, 10);
   g.drawString("Score", 10, 20);
   g.drawString(score, 10, 26);
   g.flip();
   return;
  }

  if (buttonState && !wasPressed)
   birdvy -= 2;
  wasPressed = buttonState;

  score++;
  birdvy += 0.2;
  birdvy *= 0.8;
  birdy += birdvy;
  if (birdy > g.getHeight())
   return gameStop();
  // draw bird
  g.drawImage(BIRDIMG, 0, birdy - 4);
  // draw barriers
  barriers.forEach(b => {
   b.x1 -= SPEED;
   b.x2 -= SPEED;
   var btop = b.y - b.gap;
   var bbot = b.y + b.gap;
   g.drawRect(b.x1 + 1, -1, b.x2 - 2, btop - 5);
   g.drawRect(b.x1, btop - 5, b.x2, btop);
   g.drawRect(b.x1, bbot, b.x2, bbot + 5);
   g.drawRect(b.x1 + 1, bbot + 5, b.x2 - 1, g.getHeight());
   if (b.x1 < 6 && (birdy - 3 < btop || birdy + 3 > bbot))
    return gameStop();
  });
  while (barriers.length && barriers[0].x2 <= 0) {
   barriers.shift();
   newBarrier(g.getWidth());
  }

  g.flip();
 }
 gameStart();
 setWatch(x => Badge.menu(), BTNB, { repeat: 0, debounce: 50, edge: "rising" });
};
Badge.sketch = () => {
 Badge.reset();
 function cursor() {
  for (i = -2; i <= 2; i++) {
   g.setPixel(x + i, y, !g.getPixel(x + i, y));
   g.setPixel(x, y + i, !g.getPixel(x, y + i));
  }
 }
 function onFrame() {
  cursor();
  if (BTNA.read()) { gr.setPixel(x, y, 1); g.setPixel(x, y, 1); }
  if (BTNB.read()) { gr.setPixel(x, y, 0); g.setPixel(x, y, 0); }
  if (BTNU.read()) y = (y + 63) & 63;
  if (BTND.read()) y = (y + 1) & 63;
  if (BTNL.read()) x = (x + 127) & 127;
  if (BTNR.read()) x = (x + 1) & 127;
  cursor();
  g.flip();
 }
 Badge.drawCenter(`-- Sketch! --
 
 Press A & B to return
 to the menu`);
 g.clear();
 var gr = Graphics.createArrayBuffer(128, 64, 1, { msb: true });
 if (Badge.sketchedImage) {
  gr.buffer = Badge.sketchedImage.buffer.buffer;
  g.drawImage(Badge.sketchedImage);
 } else {
  Badge.sketchedImage = { width: 128, height: 64, bpp: 1, buffer: new Uint8Array(gr.buffer), sketched: true };
  Badge.badgeImages.push(Badge.sketchedImage);
 }
 var x = 64, y = 32;
 cursor();
 // don't flip until button pressed 
 var interval;
 var BTNS = [BTNU, BTND, BTNL, BTNR, BTNA, BTNB];
 function onButton() {
  if (BTNA.read() && BTNB.read())
   return Badge.menu();
  if (digitalRead(BTNS)) {
   onFrame();
   if (!interval) interval = setInterval(onFrame, 50);
  } else {
   if (interval) clearInterval(interval);
   interval = undefined;
  }
 }
 BTNS.forEach(b=>setWatch(onButton, b, { repeat: 1, debounce: 20, edge: "both" }));
};

function onInit() {
 NRF.nfcURL(Badge.URL);
 NRF.sleep(); // no advertising
 Badge.badge();
}
